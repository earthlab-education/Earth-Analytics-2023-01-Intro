on:
  issue_comment

jobs:
  get-members:
    if: startsWith(github.event.comment.body, '/assign')
    name: Get a list of group members tagged in an issue
    runs-on: ubuntu-latest
    steps:
      - name: Read team slug
        run: >-
          echo "${{ github.event.comment.body }}" |
          sed 's/\/assign @\(.*\)$/\1/' |
          awk '{print "TEAM_SLUG="$1}' 
          >> $GITHUB_ENV
      - name: Print team slug
        run: env
        
      - name: Request team info
        id: get-team-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: >-
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /orgs/${{ github.event.repository.owner.name }}/teams/
      - name: Extract member list
        id: members
        run: >-
          echo ${{ join(fromJson(steps.get-team-info.outputs.RESP).*.login, ', ') }} |
            awk '{print "MEMBERS=["$1"]"}'
            >> $GITHUB_OUTPUT
      - name: Print team members
        run: echo ${{ steps.members.outputs.MEMBERS }}
    outputs:
      members: ${{ steps.members.outputs.MEMBERS }}
            
  assign_issues:
    needs: get-members
    runs-on: ubuntu-latest
    strategy:
      matrix:
        assignee: ${{ needs.get-members.outputs.MEMBERS }}

    steps:
      - name: Create duplicate issue for each member
        uses: imjohnbo/issue-bot@v3.4.3
        with:
          title: ${{ matrix.assignee }} ${{ github.event.issue.title }}
          body: ${{ github.event.issue.body }} 
          labels: |- 
            {{#each github.event.issue.labels}}@{{this}}{{#unless @last}}, {{/unless}}{{/each}}
          assignees: ${{ matrix.assignee }}
          milestone: ${{ github.event.issue.milestone.title }}
